# Архитектура проекта

## 1. Структура директорий

Проект будет иметь следующую структуру:

```
/
├── Tiltfile                     # Главный конфигурационный файл Tilt
├── docs/
│   ├── requirenments.md         # Функциональные и нефункциональные требования
│   └── design.md                # Описание архитектуры (этот файл)
├── helm/
│   └── app/
│       ├── Chart.yaml             # Метаданные Helm-чарта
│       ├── values.yaml            # Конфигурация по умолчанию (для локальной среды)
│       ├── values-staging.yaml    # Переопределения для staging-среды
│       ├── values-prod.yaml       # Переопределения для production-среды
│       └── templates/             # Директория с шаблонами Kubernetes
│           ├── service-a/         # Шаблоны для сервиса 'A'
│           │   ├── deployment.yaml
│           │   └── service.yaml
│           ├── service-b/         # Шаблоны для сервиса 'B'
│           │   ├── deployment.yaml
│           │   └── service.yaml
│           ├── postgresql/        # Шаблоны для опциональной локальной БД
│           │   ├── statefulset.yaml
│           │   └── service.yaml
│           └── _helpers.tpl       # Общие вспомогательные шаблоны
└── services/
    ├── service-a/               # Исходный код сервиса 'A'
    │   ├── src/
    │   └── Dockerfile
    └── service-b/               # Исходный код сервиса 'B'
        ├── src/
        └── Dockerfile
```

## 2. Логика работы

### 2.1. Управление конфигурацией (Helm)

- **Единый чарт:** Проект использует один централизованный Helm-чарт, расположенный в `helm/app`. Этот чарт отвечает за развертывание всех микросервисов и их зависимостей.
- **Структурированные шаблоны:** Шаблоны для каждого компонента системы (микросервис, база данных) сгруппированы в логические подпапки внутри `helm/app/templates` для удобства навигации и управления.
- **Управление через `values.yaml`:**
  - Включение и выключение компонентов (сервисов, локальной БД) осуществляется с помощью булевых флагов в файле `values.yaml`. Пример:
    ```yaml
    serviceA:
      enabled: true
    postgresql:
      enabled: false
    ```
  - Шаблоны в директории `templates` используют эти флаги в условных блоках `{{ if .Values.<component>.enabled }}` для контроля над созданием ресурсов Kubernetes.
- **Поддержка окружений:** Для каждой среды (staging, prod) создается свой файл `values-<env>.yaml`, который содержит только те значения, которые нужно переопределить по сравнению с `values.yaml` по умолчанию. Helm применяет эти файлы поверх базовой конфигурации при деплое в конкретную среду.

### 2.2. Процесс разработки (Tilt)

- **Точка входа:** Разработчик запускает `tilt up` в корне проекта.
- **Оркестрация Tilt:** `Tiltfile` выполняет следующие действия:
  1.  Определяет целевое окружение (по умолчанию `local`).
  2.  Для каждого активного сервиса, определенного в `values.yaml`, настраивает `docker_build` для сборки его Docker-образа из соответствующей директории в `services/`.
  3.  Формирует и выполняет команду `helm template` или `helm install`, передавая ей нужный набор `values` файлов (`-f values.yaml -f values-<env>.yaml`).
  4.  Разворачивает сгенерированные манифесты Kubernetes в локальный кластер.
  5.  Настраивает `live_update`, который отслеживает изменения в исходном коде сервисов и автоматически синхронизирует их с запущенными контейнерами, обеспечивая быструю обратную связь без полной пересборки образа.

### 2.3. Добавление нового сервиса

Процесс добавления нового сервиса (`service-c`) выглядит следующим образом:

1.  Создать директорию `services/service-c` с его `Dockerfile` и исходным кодом.
2.  Создать директорию `helm/app/templates/service-c` с его шаблонами (`deployment.yaml`, `service.yaml`).
3.  Добавить секцию `serviceC: { enabled: true, ... }` в `helm/app/values.yaml`.
4.  Добавить вызов `docker_build` для нового сервиса в `Tiltfile`.
