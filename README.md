# Демонстрационный проект: Tilt + Helm для микросервисов

Этот проект является демонстрацией использования **Tilt** и **Helm** для организации среды локальной разработки мультисервисного приложения. Он реализует гибкую архитектуру, где каждый сервис может иметь свою собственную, опциональную базу данных, а управление секретами вынесено из системы контроля версий.

## Ключевые особенности

- **Независимые базы данных:** Каждый микросервис может быть сконфигурирован с собственной, выделенной базой данных PostgreSQL.
- **Быстрая разработка:** `Tilt` обеспечивает автоматическую пересборку и live-update сервисов при изменении их исходного кода.
- **Безопасное управление секретами:** Пароли и другие чувствительные данные хранятся в файле `secrets.yaml`, который игнорируется Git, и передаются в Kubernetes через нативные `Secret`'ы.
- **Гибкая конфигурация:** `values.yaml` позволяет легко включать/отключать сервисы и их базы данных.

## Предварительные требования

- **Docker**
- **Локальный кластер Kubernetes** (Minikube, Kind, Docker Desktop)
- **[Tilt](https://docs.tilt.dev/install.html)**
- **[Helm](https://helm.sh/docs/intro/install/)** (опционально, для отладки)

## Структура проекта

```
/
├── Tiltfile
├── README.md
├── .gitignore
├── helm/app/
│   ├── Chart.yaml
│   ├── values.yaml         # Конфигурация по умолчанию
│   ├── secrets.yaml.example # Пример файла для секретов
│   └── templates/
│       ├── _helpers.tpl
│       ├── service-a/
│       └── service-b/
└── services/
    ├── service-a/
    └── service-b/
```

## Быстрый запуск

1.  **Клонируйте репозиторий.**

2.  **Создайте файл секретов.**
    Скопируйте `helm/app/secrets.yaml.example` в `helm/app/secrets.yaml`. Этот файл уже содержит примеры паролей и игнорируется Git.
    ```bash
    cp helm/app/secrets.yaml.example helm/app/secrets.yaml
    ```

3.  **Убедитесь, что ваш локальный кластер Kubernetes запущен.**

4.  **Запустите Tilt.**
    ```bash
    tilt up
    ```
    Tilt откроет веб-интерфейс (обычно на `http://localhost:10350`), где вы сможете наблюдать за состоянием всех ресурсов.

## Доступ к сервисам

- **Сервис A:** [http://localhost:8080](http://localhost:8080)
- **Сервис B:** [http://localhost:8081](http://localhost:8081)
- **База данных Сервиса A:** `localhost:5433` (если включена)
- **База данных Сервиса B:** `localhost:5432` (если включена)

## Запуск выбранных сервисов

Вы можете запускать только определенные сервисы, чтобы сэкономить ресурсы. Для этого просто перечислите их имена (в нижнем регистре, как в `services/`) как аргументы при запуске Tilt.

**Пример (запустить только Сервис B):**
```bash
tilt up serviceb
```

**Пример (запустить оба сервиса):**
```bash
tilt up servicea serviceb
```

Если аргументы не указаны, будут запущены сервисы, включенные по умолчанию в `helm/app/values.yaml`.

## Конфигурация

Основная конфигурация находится в `helm/app/values.yaml`, а чувствительные данные — в `helm/app/secrets.yaml`.

### Включение/отключение базы данных для сервиса

Откройте `helm/app/values.yaml`. У каждого сервиса есть секция `database`. Чтобы включить или выключить для него базу данных, измените флаг `enabled`.

**Пример (включить БД для Сервиса A):**
```yaml
# helm/app/values.yaml
serviceA:
  # ...
  database:
    enabled: true # <-- изменить на true
    # ... остальные настройки (user, dbName и т.д.)
```
После сохранения файла Tilt автоматически применит изменения.

### Локальная аутентификация PostgreSQL

По умолчанию, для удобства локальной разработки, базы данных PostgreSQL настроены с методом аутентификации `trust`. Это означает, что при подключении из другого контейнера внутри кластера **пароль не проверяется**. 

Пароли, указанные в `secrets.yaml`, устанавливаются в базе данных, но не требуются для локальных подключений. Это сделано для ускорения разработки. Для production-сред, где вы будете использовать внешние базы данных, безопасность будет обеспечиваться настройками самой внешней БД.

### Переход на Production (пример)

Для использования внешней базы данных, вы можете создать файл `values-prod.yaml` и переопределить в нем настройки:

```yaml
# values-prod.yaml
serviceB:
  database:
    enabled: false # Отключаем создание локальной БД
  
  # Переменные окружения для подключения к внешней БД
  # (пароль будет браться из секрета, созданного в кластере)
  env:
    DB_HOST: "my-prod-rds-instance.amazonaws.com"
    DB_USER: "prod_user"
    DB_NAME: "prod_db"
```

## Остановка окружения

```bash
tilt down
```

---

## Решение проблем

### FATAL: role "..." does not exist или Password authentication failed

**Проблема:** Вы изменили имя пользователя или пароль в `values.yaml` или `secrets.yaml`, но после перезапуска Tilt сервис все равно не может подключиться к своей базе данных.

**Причина:** Базы данных PostgreSQL, созданные с помощью `StatefulSet`, используют постоянные хранилища (`PersistentVolumeClaim` или PVC). Скрипт инициализации, который создает пользователей и устанавливает пароли, запускается **только один раз**, когда том данных пуст. Все последующие перезапуски пода просто переподключают уже существующий, "старый" том данных.

**Решение 1:** 
Подключиться к базе и изменить пароль вручную:
`kubectl exec -it main-app-service-b-db-0 -- psql -U postgres -d postgres`
Затем в psql:
`ALTER USER "user-b" WITH PASSWORD 'password-b-very-secure';`

**Решение 2, !!!уничтожающее базу!!!:** 
Если базу данных не жалко вам необходимо принудительно и полностью пересоздать базу данных, чтобы она инициализировалась с новыми настройками.

1.  **Остановите Tilt:**
    ```bash
    tilt down
    ```

2.  **Удалите StatefulSet** для нужной базы данных (замените `service-b` на нужный сервис):
    ```bash
    kubectl delete statefulset main-app-service-b-db
    ```

3.  **Удалите PersistentVolumeClaim** для этой базы. Это самый важный шаг, который уничтожает старые данные.
    ```bash
    # Имя PVC имеет формат: postgres-storage-<имя-релиза>-<имя-сервиса>-db-0
    kubectl delete pvc postgres-storage-main-app-service-b-db-0
    ```

4.  **Запустите Tilt снова:**
    ```bash
    tilt up
    ```

Теперь Kubernetes создаст и том, и базу данных с чистого листа, и она будет инициализирована с правильными, актуальными учетными данными.